// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MODELS - Multi-tenant architecture
// ============================================================================

model Tenant {
  id             String   @id @default(cuid())
  whopCompanyId  String   @unique
  name           String
  branding       Json?    // logo, colors, theme
  users          User[]
  courses        Course[]
  uploads        Upload[]
  achievements   AchievementDefinition[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("tenants")
}

model User {
  id            String   @id @default(cuid())
  whopUserId    String   @unique
  email         String   @unique
  name          String?
  role          Role     // CREATOR or LEARNER
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  lessons       Lesson[] // for creators
  progress      Progress[]
  attempts      QuizAttempt[]
  streaks       Streak[]
  uploads       Upload[] // for creators
  achievements  AchievementGrant[]
  leaderboards  LeaderboardEntry[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("users")
}

enum Role { 
  CREATOR 
  LEARNER 
}

// ============================================================================
// COURSE & CONTENT MODELS
// ============================================================================

model Lesson {
  id          String   @id @default(cuid())
  creatorId   String
  creator     User     @relation(fields: [creatorId], references: [id])
  title       String
  description String?
  content     String
  contentLink String?
  order       Int      @default(1)
  isPublished Boolean  @default(false)
  quizzes     Quiz[]
  progress    Progress[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("lessons")
}

model Course {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  title       String
  description String?
  leaderboards LeaderboardEntry[]
  certificates Certificate[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("courses")
}





// ============================================================================
// QUIZ & ASSESSMENT MODELS
// ============================================================================

model Quiz {
  id            String   @id @default(cuid())
  lessonId      String
  lesson        Lesson   @relation(fields: [lessonId], references: [id])
  title         String
  description   String?
  isPublished   Boolean  @default(false)
  questions     Question[]
  attempts      QuizAttempt[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("quizzes")
}

model Question {
  id             String   @id @default(cuid())
  quizId         String
  quiz           Quiz     @relation(fields: [quizId], references: [id])
  questionText   String
  choices        String[]
  correctAnswer  Int
  explanation    String?
  order          Int      @default(0)

  @@map("questions")
}

model QuizAttempt {
  id        String   @id @default(cuid())
  quizId    String
  quiz      Quiz     @relation(fields: [quizId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  score     Int
  totalQuestions Int
  completedAt DateTime @default(now())

  @@map("quiz_attempts")
}

// ============================================================================
// PROGRESS & TRACKING MODELS
// ============================================================================

model Progress {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  lessonId   String
  lesson     Lesson   @relation(fields: [lessonId], references: [id])
  completed  Boolean  @default(false)
  score      Int?
  timeSpent  Int?     // total seconds spent
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  @@map("progress")
}

// ============================================================================
// UPLOAD & AI GENERATION MODELS
// ============================================================================

model Upload {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  creatorId  String
  creator    User     @relation(fields: [creatorId], references: [id])
  type       UploadType  // PDF, VIDEO, DOC, TRANSCRIPT
  url        String      // S3/Supabase storage path
  status     UploadStatus @default(PENDING)
  textExtract String?     // extracted text/transcript
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("uploads")
}

enum UploadType { 
  PDF 
  VIDEO 
  DOC 
  TRANSCRIPT 
}

enum UploadStatus { 
  PENDING 
  PROCESSED 
  FAILED 
}



// ============================================================================
// ADAPTIVE LEARNING & BRANCHING MODELS
// ============================================================================



// ============================================================================
// GAMIFICATION & ENGAGEMENT MODELS
// ============================================================================

model Streak {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  count     Int      @default(0)
  lastDate  DateTime
  tenantId  String   // for tenant-specific streaks

  @@map("streaks")
}

model AchievementDefinition {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  code      String   @unique
  name      String
  description String?
  criteria  Json     // rules (e.g., pass >=90% first try)
  icon      String?  // icon identifier
  achievements AchievementGrant[]
  createdAt DateTime @default(now())

  @@map("achievement_definitions")
}

model AchievementGrant {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  definitionId String
  definition  AchievementDefinition @relation(fields: [definitionId], references: [id])
  createdAt   DateTime @default(now())

  @@map("achievement_grants")
}

model LeaderboardEntry {
  id        String   @id @default(cuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  score     Int      // aggregate (e.g., sum of best quiz scores)
  rank      Int?
  updatedAt DateTime @updatedAt

  @@map("leaderboard_entries")
}

// ============================================================================
// CERTIFICATION & COMPLETION MODELS
// ============================================================================

model Certificate {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  url       String   // generated PDF
  issuedAt  DateTime @default(now())
  tenantId  String   // for tenant isolation

  @@map("certificates")
}
